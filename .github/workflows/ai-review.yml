# .github/workflows/ai-code-review.yml
name: AI Code Review

on:
  pull_request:
    branches: [ main ]
    types: [opened]   # –∑–∞–ø—É—Å–∫–∞—î–º–æ –ª–∏—à–µ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ PR
  workflow_dispatch:   # –æ–ø—Ü—ñ–π–Ω–æ: —Ä—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –∑ Actions

permissions:
  contents: read
  pull-requests: write

jobs:
  ai_review:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      MODEL: gpt-5-nano                   # <-- –∑–∞–º—ñ–Ω–∏ –Ω–∞ –≤–∞—à ID –º–æ–¥–µ–ª—ñ
      OPENAI_API_URL: https://api.openai.com/v1/responses
      DIFF_MAX_CHARS: "150000"            # –ø—Ä–æ—Å—Ç–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏ DIFF
    steps:
      # (1) –ß–ï–ö–ê–£–¢
      - name: (1) Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (2) –í–ò–ó–ù–ê–ß–ò–¢–ò –î–Ü–§–ò base‚Ä¶HEAD
      - name: (2) Compute DIFF (base‚Ä¶HEAD, unified=0)
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"

          git diff --unified=0 "$BASE_SHA...$HEAD_SHA" > diff.patch || true

          # –¢—Ä–∏–º–º—ñ–Ω–≥ DIFF –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é —Ç–æ–∫–µ–Ω—ñ–≤/–≤–∞—Ä—Ç–æ—Å—Ç—ñ
          DIFF_CONTENT="$(cat diff.patch || true)"
          echo "raw_len=${#DIFF_CONTENT}" >> $GITHUB_OUTPUT
          printf "%s" "${DIFF_CONTENT:0:${DIFF_MAX_CHARS}}" > diff.trimmed

          if [[ ! -s diff.trimmed ]]; then
            echo "‚ö†Ô∏è Empty diff detected (nothing to review)." > comment.md
            echo "raw_len=0" >> $GITHUB_OUTPUT
          fi

      # (3) –ü–†–û–ß–ò–¢–ê–¢–ò –ó–ê–î–ê–ß–Ü –î–õ–Ø –ê–Ü –ó –§–ê–ô–õ–Ü–í
      - name: (3) Read AI instructions
        id: read_ai
        shell: bash
        run: |
          set -euo pipefail
          PROMPT_PATH=".ai/ai-reviewer-instruction.md"
          RULES_PATH=".ai/review-rules.md"

          [[ -f "$PROMPT_PATH" ]] || { echo "‚ùå Missing $PROMPT_PATH"; exit 1; }
          [[ -f "$RULES_PATH"  ]] || { echo "‚ùå Missing $RULES_PATH"; exit 1; }

          # –ù—ñ—á–æ–≥–æ –Ω–µ –≤–∏–≤–æ–¥–∏–º–æ —Ç—É—Ç ‚Äî —Ñ–∞–π–ª–∏ –ø—Ä–æ—á–∏—Ç–∞—î jq —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∫—Ä–æ—Ü—ñ

      # (4) –°–¢–í–û–†–ò–¢–ò JSON (DIFF + –ó–ê–î–ê–ß–Ü)
      - name: (4) Build request.json (safe via jq --rawfile)
        id: build
        shell: bash
        run: |
          set -euo pipefail

          jq -n \
            --arg model "$MODEL" \
            --rawfile sys   ".ai/ai-reviewer-instruction.md" \
            --rawfile rules ".ai/review-rules.md" \
            --rawfile diff  "diff.trimmed" \
            '{
              model: $model,
              response_format: { type: "json_object" },
              messages: [
                { "role": "system", "content": $sys },
                { "role": "user",   "content": ("Rules:\n" + $rules + "\n\nDIFF:\n" + $diff) }
              ]
            }' > request.json

          echo "made_request_json=true" >> $GITHUB_OUTPUT

      # (5) –í–Ü–î–ü–†–ê–í–ò–¢–ò –ó–ê–ü–ò–¢ –î–û OPENAI
      - name: (5) Call OpenAI
        id: openai
        if: steps.diff.outputs.raw_len != '0'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail

          RESP=$(curl -sS -X POST "$OPENAI_API_URL" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            --data @request.json)

          # –î—ñ—Å—Ç–∞—Ç–∏ JSON-–≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–æ–¥–µ–ª—ñ (–æ—á—ñ–∫—É—î–º–æ {"issues":[...]})
          RESULT=$(echo "$RESP" | jq -r '.choices[0].message.content // "{}"')

          # –Ø–∫—â–æ –º–æ–¥–µ–ª—å —Ä–∞–ø—Ç–æ–º –ø–æ–≤–µ—Ä–Ω—É–ª–∞ –Ω–µ-JSON, —Å–ø—Ä–æ–±—É—î–º–æ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏
          echo "$RESULT" | jq . > ai_result.json 2>/dev/null || echo '{}' > ai_result.json

          # –ü—ñ–¥–≥–æ—Ç—É—î–º–æ markdown-–∑–≤—ñ—Ç
          {
            echo "### ü§ñ AI Code Review"
            echo "_Model: \`${MODEL}\` ‚Ä¢ raw diff: ${{ steps.diff.outputs.raw_len }} chars_"
            echo
            echo "\`\`\`json"
            cat ai_result.json
            echo "\`\`\`"
          } > comment.md

      # (6) –ù–ê–ü–ò–°–ê–¢–ò –ö–û–ú–ï–ù–¢–ê–† –£ PR (sticky)
      - name: (6) Create/Update sticky comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ai-code-review
          path: comment.md
