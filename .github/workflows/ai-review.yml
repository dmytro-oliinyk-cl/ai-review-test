# .github/workflows/ai-review.yml
name: CodeGuardian AI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  # Google Gemini Configuration
  MODEL: gemini-2.5-flash
  GEMINI_API_URL: https://generativelanguage.googleapis.com/v1beta/models

  # Diff Configuration
  DIFF_MAX_CHARS: "150000"
  DIFF_UNIFIED_LINES: "0"

  # Comment Limits
  MAX_INLINE: "30"

jobs:
  ai-review:
    name: CodeGuardian Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for diff computation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run CodeGuardian AI Review
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          GEMINI_API_URL: ${{ env.GEMINI_API_URL }}
          MODEL: ${{ env.MODEL }}
          DIFF_MAX_CHARS: ${{ env.DIFF_MAX_CHARS }}
          DIFF_UNIFIED_LINES: ${{ env.DIFF_UNIFIED_LINES }}
          MAX_INLINE: ${{ env.MAX_INLINE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
        run: node scripts/run_review.js

      - name: Post summary to PR
        if: success() && hashFiles('comment.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: codeguardian-ai-review
          path: comment.md

      - name: Upload debug artifacts
        if: always() && hashFiles('request.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-debug
          path: |
            request.json
            response.json
            ai_result.json
            ai_raw_text.txt
            comment.md
            diff.trimmed
          retention-days: 7
