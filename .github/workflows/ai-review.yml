# .github/workflows/ai-review.yml
name: AI Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  step1_checkout:
    runs-on: ubuntu-latest
    steps:
      - name: (1) Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug workflow version & context
        run: |
          echo "WF STEP1 VERSION: 2025-11-11"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_SHA: $GITHUB_SHA"

      - name: (2) Compute DIFF (base…HEAD, unified=0)
        id: diff
        shell: bash
        run: |
          set -euo pipefail

          # Визначаємо SHA бази та HEAD PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"

          # Будуємо DIFF (u=0 для точних номерів рядків)
          git diff --unified=0 "$BASE_SHA...$HEAD_SHA" > diff.patch || true

          # Лімітуємо довжину DIFF (керується змінною оточення DIFF_MAX_CHARS)
          LIMIT="${DIFF_MAX_CHARS:-150000}"
          DIFF_CONTENT="$(cat diff.patch || true)"
          RAW_LEN=${#DIFF_CONTENT}
          printf "%s" "${DIFF_CONTENT:0:${LIMIT}}" > diff.trimmed
          TRIM_LEN=$(wc -c < diff.trimmed | tr -d '[:space:]')

          # Експортуємо вихідні параметри для наступних кроків
          {
            echo "raw_len=${RAW_LEN}"
            echo "trim_len=${TRIM_LEN}"
            if [[ "${TRIM_LEN}" -eq 0 ]]; then
              echo "empty=true"
            else
              echo "empty=false"
            fi
          } >> "$GITHUB_OUTPUT"
      - name: (3) Verify AI instruction files
        id: verify_ai
        shell: bash
        run: |
          set -euo pipefail
          PROMPT_PATH=".ai/ai-reviewer-instruction.md"
          RULES_PATH=".ai/review-rules.md"

          # Перевірка наявності файлів
          [[ -f "$PROMPT_PATH" ]] || { echo "❌ Missing $PROMPT_PATH"; exit 1; }
          [[ -f "$RULES_PATH"  ]] || { echo "❌ Missing $RULES_PATH"; exit 1; }

          # Мінімальна діагностика (розмір у байтах)
          SYS_BYTES=$(wc -c < "$PROMPT_PATH" | tr -d '[:space:]' || echo 0)
          RULES_BYTES=$(wc -c < "$RULES_PATH"  | tr -d '[:space:]' || echo 0)

          echo "AI instruction files found:"
          echo "  - $PROMPT_PATH (${SYS_BYTES} bytes)"
          echo "  - $RULES_PATH (${RULES_BYTES} bytes)"

          # Експортуємо значення для наступних кроків (опційно)
          {
            echo "sys_bytes=${SYS_BYTES}"
            echo "rules_bytes=${RULES_BYTES}"
          } >> "$GITHUB_OUTPUT"
      - name: (4) Build request.json (python one-liner, no heredoc)
        id: build_request
        shell: bash
        run: |
          set -euo pipefail
          python3 -c 'import os,io,json,sys; R=lambda p: (io.open(p,"r",encoding="utf-8").read() if os.path.exists(p) else ""); 
m=os.environ.get("MODEL","gpt-5-nano"); 
payload={"model":m,"response_format":{"type":"json_object"},"input":[{"role":"system","content":R(".ai/ai-reviewer-instruction.md")},{"role":"user","content":"Rules:\n"+R(".ai/review-rules.md")+"\n\nDIFF:\n"+R("diff.trimmed")}]}; 
io.open("request.json","w",encoding="utf-8").write(json.dumps(payload,ensure_ascii=False))'

